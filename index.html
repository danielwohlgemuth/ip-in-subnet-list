<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8'>
</head>

<body>
  <div>
    <label for='ip'>IP address</label>
    <input id='ip' placeholder='1.2.3.1' />
  </div>

  <div>
    <label for='subnet-list'>Subnet list with mask</label>
    <textarea id='subnet-list' placeholder='1.2.3.4/24&#10;5.6.7.8/24'></textarea>
  </div>



  <div id='output-ip'></div>

  <div id='label-description'></div>

  <table>
    <thead>
      <tr>
        <td>Subnet</td>
        <td>Valid subnet</td>
        <td>IP in subnet</td>
      </tr>
    </thead>
    <tbody id='output-list'></tbody>
  </table>

  <!-- <div id='output-list'></div> -->

  <script>
    function ipToInt(ip) {
      // From https://gist.github.com/jppommet/5708697
      return ip.split('.').reduce(function (ipInt, octet) { return (ipInt << 8) + parseInt(octet, 10) }, 0) >>> 0;
    }

    function isIpValid(ip) {
      // From https://stackoverflow.com/a/27434991/7526052
      return /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip)
    }

    function isSubnetValid(subnet) {
      // From https://stackoverflow.com/a/26445549/7526052 in comment
      return /^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\/([1-2][0-9]|3[0-2]|[0-9]))$/.test(subnet)
    }

    function splitSubnetAndMask(subnet) {
      let splitSubnet = subnet.split('/')
      let maskDifference = 32 - splitSubnet[1]

      let subnetIntIp = ipToInt(splitSubnet[0])
      let mask = Number((BigInt(4294967295) >> BigInt(maskDifference)) << BigInt(maskDifference))

      return { 'subnet': subnetIntIp, 'mask': mask }
    }

    function isIpInSubnet(ip, subnet) {
      let intIp = ipToInt(ip)
      let split = splitSubnetAndMask(subnet)

      let minIp = split.subnet & split.mask
      let maxIp = split.subnet | ~split.mask

      return minIp <= intIp && intIp <= maxIp
    }

    function processSubnet(ip, subnet) {
      let containsIp = false
      let isValid = isSubnetValid(subnet)

      if (isValid) {
        containsIp = isIpInSubnet(ip, subnet)
      }

      return { subnet, isValid, containsIp }
    }

    function processSubnetList(ip, subnetList) {
      return subnetList.map(subnet => processSubnet(ip, subnet))
    }

    function getIcon(isValid, containsIp) {
      if (!isValid) {
        return `<svg style='width:24px;height:24px' viewBox='0 0 24 24'><path fill='orange' d='M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z' /></svg>`
      } else if (!containsIp) {
        return `<svg style='width:24px;height:24px' viewBox='0 0 24 24'><path fill='red' d='M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z' /></svg>`
      } else {
        return `<svg style='width:24px;height:24px' viewBox='0 0 24 24'><path fill='green' d='M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z' /></svg>`
      }      
    }

    function generateProcessedSubnetList(subnetList) {
      let subnetListItems = subnetList.map(subnet => `<tr><td>${subnet.subnet}</td><td>${getIcon(subnet.isValid, subnet.containsIp)}</td></tr>`)
      return subnetListItems.join('')
    }

    function findSubnet() {
      let ipInput = document.getElementById('ip')
      let subnetListInput = document.getElementById('subnet-list')
      let outputIpElem = document.getElementById('output-ip')
      let outputListElem = document.getElementById('output-list')

      let ip = ipInput.value
      let subnetList = subnetListInput.value.split(/\n/)

      let processedSubnetList = []
      if (isIpValid(ip)) {
        processedSubnetList = processSubnetList(ip, subnetList)
      }

      outputListElem.innerHTML = generateProcessedSubnetList(processedSubnetList)
    }

    function getLabelDescription() {
      return `${getIcon(false, false)} ${getIcon(true, false)} ${getIcon(true, true)}`
    }

    function setup() {
      let ipInput = document.getElementById('ip')
      let subnetListInput = document.getElementById('subnet-list')
      let labelDescription = document.getElementById('label-description')

      ipInput.addEventListener('change', findSubnet)
      subnetListInput.addEventListener('change', findSubnet)
      labelDescription.innerHTML = getLabelDescription()
    }

    window.onload = setup
  </script>
</body>

</html>