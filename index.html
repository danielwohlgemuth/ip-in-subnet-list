<!DOCTYPE html>
<html>

<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Ip in Subnet List Checker</title>
</head>

<body style='font-size: 18px; color: #333;'>
  <main style='max-width: 400px; margin: 0 auto'>
    <div style='margin-bottom: 20px;'>
      <label style='display: block; font-weight:700;' for='ip'>IPv4 address</label>
      <input style='width:95%;display:block;max-width: 95%; font-size: inherit;' id='ip' placeholder='1.2.3.1' />
    </div>

    <div style='margin-bottom: 20px;'>
      <label style='display: block; font-weight:700;'  for='subnet-list'>Subnet list with mask</label>
      <textarea style='width:95%;display:block;max-width: 95%; min-width: 95%; min-height: 120px; padding: 8px; font-size: inherit;' id='subnet-list' placeholder='1.2.3.4/24&#10;5.6.7.8/24'></textarea>
    </div>

    <hr style='margin-bottom: 20px;'>

    <div style='margin-bottom: 20px;'>
      <span style='font-weight:700;'>Legend: </span>
      <div id='icon-legend'></div>
    </div>

    <div style='margin-bottom: 20px;'>
      <span style='font-weight:700;'>IP address:</span>
      <div id='output-ip'></div>
    </div>

    <table style='border-collapse: collapse; width: 100%;'>
      <thead>
        <tr>
          <td style='border-bottom: 1px solid black;width:85%;font-weight:700;'>Subnet</td>
          <td style='border-bottom: 1px solid black;width:15%; text-align: center;font-weight:700;'>Result</td>
        </tr>
      </thead>
      <tbody id='output-list'></tbody>
    </table>
  </main>

  <script>
    function ipToInt(ip) {
      // From https://gist.github.com/jppommet/5708697
      return ip.split('.').reduce(function (ipInt, octet) { return (ipInt << 8) + parseInt(octet, 10) }, 0) >>> 0
    }

    function isIpValid(ip) {
      // From https://stackoverflow.com/a/27434991/7526052
      return /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ip)
    }

    function isSubnetValid(subnet) {
      // From https://stackoverflow.com/a/26445549/7526052 in comment
      return /^(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])(\/([1-2][0-9]|3[0-2]|[0-9]))$/.test(subnet)
    }

    function splitSubnetAndMask(subnet) {
      let splitSubnet = subnet.split('/')
      let maskDifference = 32 - splitSubnet[1]

      let subnetIntIp = ipToInt(splitSubnet[0])
      let mask = Number((BigInt(4294967295) >> BigInt(maskDifference)) << BigInt(maskDifference))

      return { 'subnet': subnetIntIp, 'mask': mask }
    }

    function isIpInSubnet(ip, subnet) {
      let intIp = ipToInt(ip)
      let split = splitSubnetAndMask(subnet)

      let minIp = split.subnet & split.mask
      let maxIp = split.subnet | ~split.mask

      return minIp <= intIp && intIp <= maxIp
    }

    function processSubnet(ip, subnet) {
      let containsIp = false
      let isValid = isSubnetValid(subnet)

      if (isValid) {
        containsIp = isIpInSubnet(ip, subnet)
      }

      return { subnet, isValid, containsIp }
    }

    function processSubnetList(ip, subnetList) {
      return subnetList.map(subnet => processSubnet(ip, subnet))
    }

    function getIcon(isValid, containsIp) {
      if (!isValid) {
        return `<svg style='width:24px;height:24px;position:absolute;bottom:0' viewBox='0 0 24 24'><path fill='orange' d='M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z' /></svg>`
      } else if (!containsIp) {
        return `<svg style='width:24px;height:24px;position:absolute;bottom:0' viewBox='0 0 24 24'><path fill='red' d='M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z' /></svg>`
      } else {
        return `<svg style='width:24px;height:24px;position:absolute;bottom:0' viewBox='0 0 24 24'><path fill='green' d='M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z' /></svg>`
      }      
    }

    function encodeHTML(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;')
    }

    function generateProcessedSubnetList(subnetList) {
      let subnetListItems = subnetList.map(subnet => `<tr><td style='border-bottom: 1px solid gray;'>${subnet.subnet ? encodeHTML(subnet.subnet) : '&lt;empty&gt;'}</td><td style='border-bottom: 1px solid gray; text-align: center'><div style='position: relative'><span style='margin-right: 30px'>${getIcon(subnet.isValid, subnet.containsIp)}</div></span></td></tr>`)
      return subnetListItems.join('')
    }

    function findSubnet() {
      let ipInput = document.getElementById('ip')
      let subnetListInput = document.getElementById('subnet-list')
      let outputIpElem = document.getElementById('output-ip')
      let outputListElem = document.getElementById('output-list')

      let ip = ipInput.value
      let subnetList = subnetListInput.value.split(/\n/)

      let processedSubnetList = []
      if (isIpValid(ip)) {
        outputIpElem.innerHTML = ip
        processedSubnetList = processSubnetList(ip, subnetList)
      } else {
        outputIpElem.innerHTML = `<div style='position: relative;'>${ip ? encodeHTML(ip) : '&lt;empty&gt;'}<span style='margin-left: 10px'>${getIcon(false, false)}</span></div>`
      }

      outputListElem.innerHTML = generateProcessedSubnetList(processedSubnetList)
    }

    function getIconLegend() {
      legends = [
        `<div style='position: relative;'><span style='margin-right: 30px'>${getIcon(false, false)}</span> Invalid format</div>`,
        `<div style='position: relative;'><span style='margin-right: 30px'>${getIcon(true, false)}</span> IP is NOT in subnet</div>`,
        `<div style='position: relative;'><span style='margin-right: 30px'>${getIcon(true, true)}</span> IP is in subnet</div>`
      ]
      return `<div>${legends.join('')}</div>`
    }

    function setup() {
      let ipInput = document.getElementById('ip')
      let subnetListInput = document.getElementById('subnet-list')
      let iconLegend = document.getElementById('icon-legend')

      ipInput.addEventListener('input', findSubnet)
      subnetListInput.addEventListener('input', findSubnet)

      iconLegend.innerHTML = getIconLegend()
    }

    window.onload = setup
  </script>
</body>

</html>